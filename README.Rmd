---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```
# DEMsimulation

R Package to simulate plausible versions of SRTM and MERIT DEMs in floodplains. DEMs can be simulated from either:

* 'Average' Floodplain semi-variogram 
* Semi-variograms by landcover class

These semi-variograms were calculated for 20 floodplain locations around the world. More details of the procedure can be found in:


The spatial error structures used to simulate the DEMs have only been calculated for floodplain locations, and thus should only be applied to floodplain locations. A similar procedure can be used for landscapes with steep relief with several papers assessing DEM simulation and slope failure at the bottom of this page.

## Installation

Currently, DEMsimulation is only available on Github. To download and install use the following:

```{r installation, eval = FALSE}
devtools::install_github("laurencehawker/DEMsimulation")
```

## Using DEMsimulation

First, load DEMsimulation

```{r, message=FALSE}
library(DEMsimulation)
```

### DEM

Next load a DEM. For this example, we will use the MERIT DEM for Ba, Fiji which is included in the package. Oterwise load your DEM (MERIT or SRTM) using the raster package. To download MERIT DEM data please see  [MERIT DEM](http://hydro.iis.u-tokyo.ac.jp/~yamadai/MERIT_DEM/). Do note the semi-variograms have so far only been calculated for MERIT and SRTM at 90m resolution.

```{r, message=FALSE}

#Load MERIT DEM for Ba
data("Ba_MERIT")

#Show raster details of Ba
Ba_MERIT

#Plot Ba DEM
plot(Ba_MERIT)
```

There is an option to simulate by landcover semi-variograms, whereby the DEM is divided by landcover class, with the appropriate semi-variogram applied to related pixels. When a landcover type is not within the DEMsimulation database, the average floodplains semi-vaiogram is used. The available landcover semi-variograms are:

```{r, message=FALSE}
data("MERIT_AvgSV_LC")
names(MERIT_Avg_LC)
```

### Landcover

The Landcover classes were taken from the Climate Change Institute [CCI](http://maps.elie.ucl.ac.be/CCI/viewer/index.php) for the year 2000. The user can either download this themselves, or use the download.CCI function in DEMsimulation. The download.CCI function is handy as it downloads and resamples the landcover data from it's native resolution of 300m to 90m (DEM resolution).

```{r, message=FALSE}
#Download Landcover data and resample.
LC_Map <- download.CCI(Ba_MERIT)
LC_Map

#Alternatively load from local computer and resample
LC_Map_local <-raster('ESA_Landcover_Map.tif') #Load CCI Landcover Map
ex<- raster::extent(Ba_MERIT) #Extent of DEM
LC_Map_local <- raster::crop(LC_Map_local,ex) #Crop CCI Landcover Map
CCI <-raster::resample(lcmap_rascrop,targetDEM,method='ngb') #Resample to DEM resolution
```

### DEM Simulation

Now to simulate those DEMs! The user can choose to simulate either by landcover class (slower but marginally 'better' quality simulations), by the average floodplain semi-variogram, or by any other landcover semivariogram.

The user should be warned that simulating DEMs can be slow, so please be patient and sensible with the size of the DEM for the computer that is being used for the work.

The DEM simulation code mainly uses the excellent [gstat package](https://cran.r-project.org/web/packages/gstat/index.html). Please check the documentation in gstat for more information.

```{r, eval=FALSE,message=FALSE}
###Simulate DEM by landcover
sim_LC <- demsimulation_LC(Ba_MERIT,LC_map = LC_map, maxdist = 0.01, nsim = 20) 

#Write simulated Rasters
#Writes out the simulated rasters with a numbered suffix in geotiff format. See writeRaster function documentation in the raster package for other formats.
writeRaster(sim_LC,filename = 'Ba_MERIT_LC', bylayer=TRUE, suffix='numbers',format='GTiff')

#####

#Simulate DEMs by average floodplain semi-variogram
modelselect <- MERIT_Avg_LC$Overall #Average floodplain semi-variogram
#Simulate DEMs by average floodplain semi-variogram
sim_avg <- demsimulation(Ba_MERIT,sv=modelselect, maxdist = 0.01, nsim = 20)
writeRaster(sim_avg,filename = 'Ba_MERIT_avgsv', bylayer=TRUE, suffix='numbers',format='GTiff')

#####

#Simulate DEMs by cropland landcover class. Any other landcover can be selected
modelselectCrop <- MERIT_Avg_LC$Cropland #Cropland semi-variogram
#Simulate DEMs by Cropland semi-variogram
sim_Crop <- demsimulation(Ba_MERIT,sv=modelselectCrop, maxdist = 0.01, nsim = 20)
writeRaster(sim_Crop,filename = 'Ba_MERIT_cropsv', bylayer=TRUE, suffix='numbers',format='GTiff')
```

## Performance

Let's access the speed of DEM simulation

```{r,message=FALSE}
#For the Ba Catchment. DEM size 79x138 pixels
library(microbenchmark)
mbm <- microbenchmark(
  Simulation_Landcover <- demsimulation_LC(Ba_MERIT,LC_map = LC_map, maxdist = 0.01, nsim = 20),
  Simulation_AverageSV <- demsimulation(Ba_MERIT,sv=modelselect, maxdist = 0.01, nsim = 20),
  Simulation_CroplandSV <- demsimulation(Ba_MERIT,sv=modelselectCrop, maxdist = 0.01, nsim = 20),
  times = 1
)
plot(mbm)
```

## Use in Flood Models

The main motivation behind this work was to simulate DEMs for flood studies as typically only a single DEM are used, especially in data-sparse areas. In our [WRR paper](https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1029/2018WR023279) we simulate DEMs for An Giang Province in Vietnam and Ba in Fiji, and use the simulated DEMs in a LISFLOOD-FP flood model. By using multiple DEMs, we can produce a probablistic flood map based on topographic uncertainty. Therefore, the DEM simulation procedure is invaluable in helping to explore the impact of topographic uncertainty on flood inundation extent. LISFLOOD-FP is freely available for non-commercial use from [here](http://www.bristol.ac.uk/geography/research/hydrology/models/lisflood/)

DEM simulation has also recently been applied to a study assessing river-floodplain connectivity in the [Congo Basin](https://agu.confex.com/agu/18chapman4/meetingapp.cgi/Paper/341976). 

## Future Plans

Future plans include adding more locations (and thus landcover classes), and assessing the NASADEM when it is released.

## Citation

When using this code please cite:


## References & related works





